<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Luna MCP Public Console</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" integrity="sha512-YH8VEWilR92pT9XyM54q9WlH0I1GtIsfRSAxEPPGjBJOCa/MEGLjm+rXhN3kLBXjg5eQof8I4eAbOe+tfLOcNA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
  :root { color-scheme: dark; --bg:#1e1e1e; --panel:#252526; --border:#333; --text:#d4d4d4; --accent:#007acc; --accent-hover:#1384d3; --danger:#f14c4c; --success:#2ea043; --muted:#848484; --radius:8px; }
  body { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; margin:0; padding:2rem 2.2rem; background:var(--bg); color:var(--text); line-height:1.4; }
  h1 { margin:0 0 1rem; display:flex; align-items:center; gap:.75rem; font-size:1.35rem; font-weight:600; }
  h2 { margin:.2rem 0 1rem; font-size:1rem; text-transform:uppercase; letter-spacing:.05em; font-weight:600; color:var(--muted); }
  section { background:var(--panel); padding:1.1rem 1.25rem 1.3rem; border:1px solid var(--border); border-radius:var(--radius); margin-top:1.5rem; }
  section:first-of-type { margin-top:1.25rem; }
  label { font-size:.75rem; text-transform:uppercase; letter-spacing:.05em; font-weight:600; display:block; margin:.75rem 0 .35rem; color:var(--muted); }
  input, textarea, select { width:100%; box-sizing:border-box; background:#1b1b1b; color:var(--text); border:1px solid var(--border); border-radius:6px; padding:0.55rem .65rem; font:inherit; resize:vertical; }
  textarea { min-height:120px; }
  button { background:var(--accent); color:#fff; border:1px solid var(--accent); border-radius:6px; padding:0.55rem .95rem; cursor:pointer; font-weight:600; font-size:.85rem; letter-spacing:.02em; display:inline-flex; align-items:center; gap:.4rem; }
  button:hover:not(:disabled) { background:var(--accent-hover); }
  button.secondary { background:#2d2d2d; border-color:#2d2d2d; }
  button.secondary:hover:not(:disabled){ background:#363636; }
  button:disabled { opacity:.45; cursor:not-allowed; }
  .btn-row { display:flex; flex-wrap:wrap; gap:.75rem; margin:1rem 0 .25rem; }
  pre { background:#1b1b1b; border:1px solid var(--border); padding:.9rem 1rem; border-radius:6px; overflow:auto; max-height:320px; font-size:.8rem; line-height:1.35; }
  pre code { font-family:inherit; font-size:inherit; }
  .tool-lat-head { margin-top:1.25rem; }
  table.lat { width:100%; border-collapse:collapse; font-size:.7rem; }
  table.lat th, table.lat td { padding:4px 6px; border-bottom:1px solid var(--border); }
  table.lat th { text-align:left; font-weight:600; color:var(--muted); }
  table.lat td.num, table.lat th.num { text-align:right; }
  .status { font-size:.7rem; margin-top:.4rem; font-family:inherit; letter-spacing:.03em; }
  .ok { color:var(--success); }
  .err { color:var(--danger); }
  .badge { display:inline-block; padding:2px 8px; font-size:11px; background:#2d2d2d; border:1px solid var(--border); border-radius:999px; margin:2px 4px 2px 0; }
  footer { margin:3rem 0 0; font-size:.65rem; opacity:.55; text-align:center; }
  a.link { color:var(--accent); text-decoration:none; }
  a.link:hover { text-decoration:underline; }
  .bar { display:flex;justify-content:space-between;align-items:flex-end;gap:2rem;flex-wrap:wrap; margin-top:.75rem; }
  .chart { width:100%;max-width:420px; }
  .mt1 { margin-top:1rem; }
  .sse-log { max-height:160px; }
  .flex { display:flex; gap:.75rem; align-items:center; flex-wrap:wrap; }
  nav.tabs { display:flex; gap:.65rem; }
  .tab { background:#2d2d2d; border:1px solid var(--border); padding:.45rem .85rem; border-radius:5px; font-size:.7rem; font-weight:600; letter-spacing:.05em; text-transform:uppercase; color:var(--muted); }
  .tab.active { background:var(--accent); border-color:var(--accent); color:#fff; }
  .tab:not(.active):hover { background:#363636; color:#c0c0c0; }
  details summary { cursor:pointer; font-size:.75rem; letter-spacing:.04em; }
  header.logo-wrap img { height:40px; width:auto; border-radius:6px; box-shadow:0 0 0 1px var(--border); }
  .lead { margin:.2rem 0 1.1rem; font-size:.8rem; color:var(--muted); }
  .split { display:grid; gap:1.5rem; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); }
  @media (max-width:760px){ .bar { flex-direction:column; align-items:stretch; } }
  </style>
</head>
<body>
  <header class="logo-wrap">
    <h1><img src="assets/logo.png" alt="Luna Logo" /> Luna MCP Console</h1>
    <p class="lead">Curated sandbox of public, sanitized MCP tools.</p>
  </header>
  <div id="health" class="status" role="status" aria-live="polite">Loading health…</div>

  <div class="bar">
    <nav class="tabs" role="tablist" aria-label="Console Sections">
    <button class="tab active" data-tab="run" role="tab" aria-selected="true">Run Tool</button>
    <button class="tab" data-tab="docs" role="tab" aria-selected="false">Tool Docs</button>
    <button class="tab" data-tab="validate" role="tab" aria-selected="false">Validate</button>
    </nav>
    <div class="flex">
      <button class="secondary" id="resetHist" type="button">Reset Stats</button>
    </div>
  </div>

  <section class="panel active" id="panel-run" role="tabpanel" aria-labelledby="tab-run">
    <h2>Execute Tool</h2>
    <label for="toolSelect">Tool</label>
    <select id="toolSelect" aria-describedby="toolHelp"></select>
    <div id="toolHelp" class="status">Select a tool to view description.</div>
    <label for="params">Parameters (JSON)</label>
    <textarea id="params" placeholder='{"prompt":"Hello"}' aria-label="Tool parameters"></textarea>
    <div class="btn-row">
      <button id="runBtn">▶ Run</button>
      <button class="secondary" id="clearBtn" type="button">Clear</button>
      <button class="secondary" id="curlBtn" type="button">Copy curl</button>
    </div>
    <div id="execStatus" class="status" aria-live="polite"></div>
    <pre id="result" aria-label="Result output" tabindex="0"><code class="language-javascript" id="resultCode"></code></pre>
    <h3>Latency Histogram (ms)</h3>
  <canvas id="latencyChart" height="120" class="chart"></canvas>
  <h3 class="tool-lat-head">Per-Tool Latency (avg ms)</h3>
  <table id="latTable" class="lat">
    <thead><tr><th>Tool</th><th class="num">Calls</th><th class="num">Avg</th><th class="num">P95</th></tr></thead>
    <tbody></tbody>
  </table>
  <details class="mt1"><summary>SSE Stream (experimental)</summary>
      <p>When future streaming tools are available, output will appear below.</p>
  <pre id="sseOut" class="sse-log"></pre>
      <div class="btn-row">
        <button class="secondary" id="sseStart" type="button">Start Stream</button>
        <button class="secondary" id="sseStop" type="button" disabled>Stop</button>
      </div>
    </details>
  </section>

  <section class="panel" id="panel-docs" role="tabpanel" aria-labelledby="tab-docs">
    <h2>Tool Documentation</h2>
    <div id="toolDocs">Select a tool to load its description.</div>
  </section>

  <section class="panel" id="panel-validate" role="tabpanel" aria-labelledby="tab-validate">
    <h2>Validate Tool</h2>
    <p>Returns the server validation number required for some MCP integrations.</p>
    <button id="validateBtn">Get Number</button>
    <pre id="validateOut"></pre>
  </section>

  <footer>© 2025 Luna MCP • Public tools only • <a class="link" href="https://github.com/Drago-03/Luna-MCP-Services" target="_blank" rel="noopener">Source</a></footer>

<script>
async function fetchJSON(url, opts={}, attempt=1) {
  const maxAttempts = 4;
  try {
    const res = await fetch(url, {headers:{'Content-Type':'application/json'}, ...opts});
    if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    return await res.json();
  } catch(e){
    if(attempt < maxAttempts && (e.message.startsWith('5') || e.message.includes('Network'))){
      const backoff = Math.min(1500, 100 * 2 ** (attempt-1));
      await new Promise(r=>setTimeout(r, backoff));
      return fetchJSON(url, opts, attempt+1);
    }
    throw e;
  }
}
async function loadHealth(){
  try {
    const h = await fetchJSON('/public/health');
    document.getElementById('health').innerHTML = `Status: <span class='ok'>OK</span> • Public tools: ${h.tools.map(t=>`<span class=badge>${t}</span>`).join('')}`;
    const sel = document.getElementById('toolSelect');
    sel.innerHTML = h.tools.map(t=>`<option value="${t}">${t}</option>`).join('');
    if(h.tools.length){ selectTool(h.tools[0]); }
  } catch(e){
    document.getElementById('health').innerHTML = `<span class='err'>Health error: ${e.message}</span>`;
  }
}

async function selectTool(name){
  const help = document.getElementById('toolHelp');
  const docs = document.getElementById('toolDocs');
  help.textContent = 'Loading description…';
  try {
    const d = await fetchJSON(`/public/describe/${encodeURIComponent(name)}`);
    help.innerHTML = `<span class='ok'>${d.tool}</span>: ${d.description}`;
  docs.innerHTML = `<h3 style='margin-top:0'>${d.tool}</h3><p>${d.description}</p><p><strong>Invoke:</strong> POST /public/execute {"method":"${d.tool}","params":{}}</p>`;
  } catch(e){
    help.innerHTML = `<span class='err'>Description error: ${e.message}</span>`;
  }
}

async function runTool(){
  const tool = document.getElementById('toolSelect').value;
  let paramsRaw = document.getElementById('params').value.trim();
  let params = {};
  if(paramsRaw){
    try { params = JSON.parse(paramsRaw); }
    catch(e){
      document.getElementById('execStatus').innerHTML = `<span class='err'>Param JSON error: ${e.message}</span>`; return;
    }
  }
  document.getElementById('runBtn').disabled = true;
  document.getElementById('execStatus').textContent = 'Running…';
  document.getElementById('result').textContent='';
  const start = performance.now();
  try {
    const r = await fetchJSON('/public/execute', {method:'POST', body: JSON.stringify({method: tool, params})});
  const ms = Math.round(performance.now()-start);
  recordLatency(ms);
  recordToolLatency(tool, ms);
  document.getElementById('execStatus').innerHTML = `<span class='ok'>Success</span> (${ms} ms)`;
    const codeEl = document.getElementById('resultCode');
    codeEl.textContent = JSON.stringify(r, null, 2);
    Prism.highlightElement(codeEl);
  } catch(e){
    document.getElementById('execStatus').innerHTML = `<span class='err'>Error: ${e.message}</span>`;
  } finally { document.getElementById('runBtn').disabled = false; }
}

async function validate(){
  const out = document.getElementById('validateOut');
  out.textContent='';
  try {
    const r = await fetchJSON('/public/execute', {method:'POST', body: JSON.stringify({method:'validate', params:{}})});
  out.textContent = JSON.stringify(r, null, 2);
  } catch(e){
    out.textContent = 'Error: '+ e.message;
  }
}

function copyCurl(){
  const tool = document.getElementById('toolSelect').value;
  let paramsRaw = document.getElementById('params').value.trim();
  if(!paramsRaw) paramsRaw = '{}';
  const cmd = `curl -X POST ${location.origin}/public/execute -H 'Content-Type: application/json' -d '{"method":"${tool}","params":${paramsRaw}}'`;
  navigator.clipboard.writeText(cmd).then(()=>{
    const s = document.getElementById('execStatus');
    s.innerHTML = `<span class='ok'>Copied curl snippet</span>`;
  }).catch(()=>{});
}

// Latency tracking
const histKey = 'luna_mcp_latency';
const toolLatencyKey = 'luna_mcp_tool_latency';
function loadLatency(){
  try { return JSON.parse(localStorage.getItem(histKey)||'[]'); } catch { return []; }
}
function saveLatency(arr){ localStorage.setItem(histKey, JSON.stringify(arr.slice(-200))); }
function recordLatency(ms){ const data = loadLatency(); data.push(ms); saveLatency(data); drawLatency(); }
function bucketize(arr){
  if(!arr.length) return [];
  const max = Math.max(...arr); const step = Math.max(10, Math.ceil(max/10));
  const buckets = [];
  for(let edge=0; edge<=max+step; edge+=step){ buckets.push({edge, count:0}); }
  for(const v of arr){
    const idx = Math.min(buckets.length-1, Math.floor(v/step));
    buckets[idx].count++;
  }
  return {buckets, step};
}
function drawLatency(){
  const canvas = document.getElementById('latencyChart'); if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const data = loadLatency();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!data.length){ ctx.fillStyle = '#777'; ctx.fillText('No data yet', 10,20); return; }
  const {buckets, step} = bucketize(data);
  const maxCount = Math.max(...buckets.map(b=>b.count));
  const w = canvas.width / buckets.length;
  buckets.forEach((b,i)=>{
    const h = (b.count / maxCount) * (canvas.height - 20);
    ctx.fillStyle = '#238636';
    ctx.fillRect(i*w, canvas.height - h, w-4, h);
  });
  ctx.fillStyle = '#999';
  ctx.font = '10px system-ui';
  buckets.forEach((b,i)=>{
    ctx.fillText(`${b.edge}`, i*w+2, canvas.height-2);
  });
}

function loadToolLatency(){
  try { return JSON.parse(localStorage.getItem(toolLatencyKey)||'{}'); } catch { return {}; }
}
function saveToolLatency(obj){ localStorage.setItem(toolLatencyKey, JSON.stringify(obj)); }
function recordToolLatency(tool, ms){
  const data = loadToolLatency();
  data[tool] = data[tool] || [];
  data[tool].push(ms);
  if(data[tool].length>200) data[tool]=data[tool].slice(-200);
  saveToolLatency(data);
  renderToolLatency();
}
function percentile(arr, p){ if(!arr.length) return 0; const sorted=[...arr].sort((a,b)=>a-b); const idx=Math.min(sorted.length-1, Math.floor(p/100*sorted.length)); return sorted[idx]; }
function renderToolLatency(){
  const tbl = document.querySelector('#latTable tbody'); if(!tbl) return;
  const data = loadToolLatency();
  const rows = Object.entries(data).map(([tool, arr])=>{
    const avg = Math.round(arr.reduce((a,b)=>a+b,0)/arr.length);
    const p95 = percentile(arr,95);
    return `<tr><td style='padding:3px 6px;border-bottom:1px solid var(--border)'>${tool}</td><td style='padding:3px 6px;text-align:right;border-bottom:1px solid var(--border)'>${arr.length}</td><td style='padding:3px 6px;text-align:right;border-bottom:1px solid var(--border)'>${avg}</td><td style='padding:3px 6px;text-align:right;border-bottom:1px solid var(--border)'>${p95}</td></tr>`;
  }).join('');
  tbl.innerHTML = rows || `<tr><td colspan='4' style='padding:6px;color:var(--muted)'>No data</td></tr>`;
}

// No theme toggle (locked dark coding theme)

// Params persistence
const paramKey='luna_mcp_params';
function loadParams(){ const v = localStorage.getItem(paramKey); if(v) document.getElementById('params').value = v; }
document.getElementById('params').addEventListener('input', e=> localStorage.setItem(paramKey, e.target.value));

// SSE streaming (real endpoint)
let evtSource = null;
function startSSE(){
  if(evtSource){ evtSource.close(); }
  const tool = document.getElementById('toolSelect').value;
  const paramsRaw = document.getElementById('params').value.trim();
  const q = new URLSearchParams({method: tool});
  if(paramsRaw) q.set('params', paramsRaw);
  evtSource = new EventSource('/public/stream?'+q.toString());
  const out = document.getElementById('sseOut');
  out.textContent='';
  document.getElementById('sseStart').disabled=true;
  document.getElementById('sseStop').disabled=false;
  evtSource.addEventListener('start', ()=>{ out.textContent += '[start]\n'; });
  evtSource.addEventListener('end', ()=>{ out.textContent += '\n[end]\n'; stopSSE(); });
  evtSource.addEventListener('error', ev=>{ out.textContent += `\n[error]\n`; });
  evtSource.onmessage = (ev)=>{
    try {
      const data = JSON.parse(ev.data);
      if(data.chunk){ out.textContent += data.chunk; }
    } catch { out.textContent += ev.data; }
    out.scrollTop = out.scrollHeight;
  };
}
function stopSSE(){ if(evtSource){ evtSource.close(); evtSource=null; } document.getElementById('sseStart').disabled=false; document.getElementById('sseStop').disabled=true; }

document.getElementById('sseStart').addEventListener('click', startSSE);
document.getElementById('sseStop').addEventListener('click', stopSSE);

// Tabs
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(b=>{b.classList.remove('active'); b.setAttribute('aria-selected','false');});
    btn.classList.add('active'); btn.setAttribute('aria-selected','true');
    const tab = btn.getAttribute('data-tab');
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    document.getElementById(`panel-${tab}`).classList.add('active');
  });
});

// Wire events
document.getElementById('runBtn').addEventListener('click', runTool);
document.getElementById('clearBtn').addEventListener('click', ()=>{document.getElementById('params').value=''; document.getElementById('result').textContent=''; document.getElementById('execStatus').textContent='';});
document.getElementById('validateBtn').addEventListener('click', validate);
document.getElementById('curlBtn').addEventListener('click', copyCurl);
document.getElementById('toolSelect').addEventListener('change', e=> selectTool(e.target.value));
document.getElementById('resetHist').addEventListener('click', ()=>{ localStorage.removeItem(histKey); drawLatency(); document.getElementById('execStatus').innerHTML='<span class="ok">Latency stats reset</span>'; });
// Clean up: ensure no leftover theme toggle element
const orphanToggle = document.getElementById('themeToggle'); if(orphanToggle) orphanToggle.remove();

renderToolLatency();
drawLatency();
loadParams();

loadHealth();
</script>
</body>
</html>
